<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carbonoz SolarAutopilot</title>
 

 
   <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
   <link rel="stylesheet" href="<%= ingress_path %>/css/main.css">
   <link rel="stylesheet" href="<%= ingress_path %>/css/messages.css">
</head>
<body>
      <!-- Add hamburger menu button -->
      <button class="mobile-toggle" id="mobileToggle">
        <span></span>
        <span></span>
        <span></span>
    </button>
    <div class="container">
        <div id="loadingOverlay" class="loading-overlay">
            <div class="loading-spinner"></div>
          </div>
          <div id="pageContent"> </div>
<%- include('partials/sidebar') %>

        <div class="main-container">

            <div class="main-content">
                <div class="content-card">
                    <section>
                        <main>
                         
                            <div class="messages-header">
                                <h3><i class="icon-messages">üì®</i> Incoming Messages</h3>
                                <div class="message-stats">
                                    <span class="stats-item">
                                        <span class="stats-label">Total:</span>
                                        <span class="stats-value" id="totalMessages">0</span>
                                    </span>
                                    <span class="stats-item">
                                        <span class="stats-label">Live:</span>
                                        <span class="stats-indicator" id="liveIndicator">‚óè</span>
                                    </span>
                                </div>
                            </div>
                            
                            <div class="controls">
                                <div class="filter-group">
                                    <label for="categoryFilter">üìÇ Category:</label>
                                    <select id="categoryFilter">
                                        <% categoryOptions.forEach(function(category) { %>
                                            <option value="<%= category %>"><%= category.charAt(0).toUpperCase() + category.slice(1).replace(/(\d+)$/, ' $1') %></option>
                                        <% }); %>
                                    </select>
                                </div>
                                <div class="action-buttons">
                                    <button id="refreshButton" class="btn-primary">
                                        <span class="btn-icon">üîÑ</span>
                                        <span class="btn-text">Refresh</span>
                                    </button>
                                    <button id="clearButton" class="btn-secondary">
                                        <span class="btn-icon">üóëÔ∏è</span>
                                        <span class="btn-text">Clear</span>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="message-container">
                                <div id="messageList" class="message-list"></div>
                                <div id="emptyState" class="empty-state" style="display: none;">
                                    <div class="empty-icon">üì≠</div>
                                    <h4>No Messages Found</h4>
                                    <p>No messages available for the selected category.</p>
                                </div>
                            </div>
                        </main>
                    </section>
                </div>
            </div>

        </div>
    </div>
  <script>
       
 
       const messageList = document.getElementById('messageList');
    const categoryFilter = document.getElementById('categoryFilter');
    const refreshButton = document.getElementById('refreshButton');
    const ingressPath = '<%= ingress_path %>';
    
    function fetchMessages() {
        const category = categoryFilter.value;
        fetch(`${ingressPath}/api/messages?category=${category}`)
            .then(response => response.json())
            .then(messages => {
                messageList.innerHTML = '';
                document.getElementById('totalMessages').textContent = messages.length;
                
                if (messages.length === 0) {
                    messageList.style.display = 'none';
                    document.getElementById('emptyState').style.display = 'block';
                } else {
                    messageList.style.display = 'block';
                    document.getElementById('emptyState').style.display = 'none';
                    
                    messages.forEach((message, index) => {
                        const [topic, value] = message.split(': ');
                        const messageElement = document.createElement('div');
                        messageElement.className = 'message';
                        
                        const messageIcon = getMessageIcon(topic);
                        const timestamp = new Date().toLocaleTimeString();
                        
                        messageElement.innerHTML = `
                            <div class="message-header">
                                <div class="message-icon">${messageIcon}</div>
                                <div class="message-topic">${topic}</div>
                                <div class="message-time">${timestamp}</div>
                            </div>
                            <div class="message-content">
                                <div class="message-value">${value}</div>
                            </div>
                        `;
                        messageList.appendChild(messageElement);
                    });
                }
            })
            .catch(error => console.error('Error fetching messages:', error));
    }
    
    categoryFilter.addEventListener('change', fetchMessages);
    refreshButton.addEventListener('click', fetchMessages);
    
    // Helper function to get appropriate icon for message type
    function getMessageIcon(topic) {
        if (topic.includes('battery')) return 'üîã';
        if (topic.includes('solar') || topic.includes('pv')) return '‚òÄÔ∏è';
        if (topic.includes('grid')) return '‚ö°';
        if (topic.includes('power')) return 'üîå';
        if (topic.includes('voltage')) return 'üìä';
        if (topic.includes('temperature')) return 'üå°Ô∏è';
        if (topic.includes('status') || topic.includes('state')) return 'üìç';
        if (topic.includes('error') || topic.includes('fault')) return '‚ö†Ô∏è';
        return 'üì°';
    }
    

    
    // Clear messages function
    document.getElementById('clearButton').addEventListener('click', () => {
        messageList.innerHTML = '';
        document.getElementById('totalMessages').textContent = '0';
        document.getElementById('emptyState').style.display = 'block';
        messageList.style.display = 'none';
    });
    
    // Auto-refresh every 5 seconds
    setInterval(() => {
        fetchMessages();
    }, 5000);
    
    // Initial fetch
    fetchMessages();
    
  </script>

    <script src="<%= ingress_path %>/js/loading.js"></script>
    <script src="<%= ingress_path %>/js/dark-mode.js"></script>
    <script src="<%= ingress_path %>/js/mobile.js"></script>
</body>
</html>