<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carbonoz SolarAutopilot</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="<%= ingress_path %>/css/main.css">
    <style>
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
           background: #DEAF0B;
            padding: 1.5rem;
            border-radius: 1rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .results-header h1 {
            background: #fff;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .period-tabs {
            display: flex;
            gap: 0.25rem;
            background: rgba(255, 255, 255, 0.1);
            padding: 0.25rem;
            border-radius: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .period-tab {
            padding: 0.75rem 1.25rem;
            border: none;
            background: transparent;
            color: var(--text-color);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }
        
        .period-tab.active {
            background: linear-gradient(135deg, #DEAF0B, lab(88.11% -2.41 70.17));
            color: white;
            box-shadow: 0 4px 15px rgba(56, 249, 215, 0.4);
            transform: translateY(-1px);
        }
        
        .export-buttons {
            display: flex;
            gap: 0.5rem;
        }
        
        .export-btn {
            padding: 0.75rem 1.25rem;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-color);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
        }
        
        .export-btn:hover {
            color: white;
            border-color: #38f9d7;
           background: linear-gradient(135deg, #DEAF0B, lab(88.11% -2.41 70.17));
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(56, 249, 215, 0.3);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 1rem;
            border: 1px solid var(--border-color);
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #ecfd2d, #DEAF0B);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            border-color: rgba(56, 249, 215, 0.3);
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
          background: linear-gradient(135deg, #38f9d7, #4facfe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            line-height: 1.2;
        }
        
        .stat-label {
            color: var(--text-secondary);
            font-size: 0.95rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .chart-card {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 1rem;
            border: 1px solid var(--border-color);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .chart-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(135deg, #ecfd2d, #DEAF0B);
        }
        
        .chart-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }
        
        .chart-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* Dark Mode Chart Styles */
        .dark-mode .chart-card {
         background-color: rgba(24, 27, 31, 1);
            border-color: #334155;
        }
        
        .dark-mode .chart-title {
            color: #f1f5f9;
        }
        
        .dark-mode .chart-container {
          background-color: rgb(32, 36, 41);
            border-radius: 0.5rem;
        }
        
        .dark-mode .chart-container canvas {
            filter: brightness(1.1) contrast(1.05);
        }
        
        .dark-mode .gauge-value {
            color: #38f9d7;
            text-shadow: 0 0 10px rgba(56, 249, 215, 0.3);
        }
        .chart-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: linear-gradient(135deg, #ecfd2d, #DEAF0B);
            border-radius: 2px;
        }
        
        .chart-container {
            position: relative;
            height: 320px;
        }
        
        .gauge-container {
            position: relative;
            height: 220px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .gauge-value {
            position: absolute;
            top: 60%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.8rem;
            font-weight: 800;
            background: linear-gradient(135deg, #38f9d7, #4facfe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .data-table-container {
            background: var(--card-bg);
            border-radius: 1rem;
            border: 1px solid var(--border-color);
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .data-table-container:hover {
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }
        
        .table-header {
            padding: 1.5rem 2rem;
            background: #DEAF0B;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .table-title {
            font-size: 1.3rem;
            font-weight: 700;
            background: #fff;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .table-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
            font-weight: 500;
        }
        
        .entries-select {
            padding: 0.5rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: 0.5rem;
            background: var(--card-bg);
            color: var(--text-color);
            font-weight: 500;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .entries-select:focus {
            outline: none;
            border-color: #38f9d7;
            box-shadow: 0 0 0 3px rgba(56, 249, 215, 0.1);
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }
        
        /* White Mode Table Optimization */
        .data-table th {
            padding: 1.25rem 1rem;
            text-align: left;
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            font-weight: 700;
            color: #1e293b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.85rem;
            border-bottom: 3px solid #DEAF0B;
            position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .data-table th:hover {
            background: linear-gradient(135deg, #e2e8f0, #cbd5e1);
        }
        
        .data-table td {
            padding: 1rem;
            border-bottom: 1px solid rgba(226, 232, 240, 0.3);
            color: #475569;
            font-weight: 500;
            transition: all 0.2s;
            background: #ffffff;
        }
        
        .data-table tbody tr {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        
        .data-table tbody tr:hover {
            background: linear-gradient(135deg, rgba(222, 175, 11, 0.08), rgba(236, 253, 45, 0.05));
            transform: scale(1.01);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .data-table tbody tr:nth-child(even) {
            background: #f8fafc;
        }
        
        .data-table tbody tr:nth-child(even):hover {
            background: linear-gradient(135deg, rgba(222, 175, 11, 0.08), rgba(236, 253, 45, 0.05));
        }
        
        /* Dark Mode Table Styles */
        .dark-mode .data-table-container {
            background: #1e293b;
            border-color: #334155;
        }
        

        
        .dark-mode .table-title {
            color: #ecfd2d;
        }
        
        .dark-mode .data-table th {
            background: linear-gradient(135deg, #334155, #475569);
            color: #f1f5f9;
            border-bottom-color: #38f9d7;
        }
        
        .dark-mode .data-table th:hover {
            background: linear-gradient(135deg, #475569, #64748b);
        }
        
        .dark-mode .data-table td {
           background-color: rgba(24, 27, 31, 1);
            color: #cbd5e1;
            border-bottom-color: rgba(51, 65, 85, 0.5);
        }
        
        .dark-mode .data-table tbody tr:nth-child(even) {
            background: #0f172a;
        }
        
        .dark-mode .data-table tbody tr:hover {
            background: linear-gradient(135deg, rgba(236, 253, 45, 0.1), rgba(56, 249, 215, 0.05));
        }
        
        .dark-mode .data-table tbody tr:nth-child(even):hover {
            background: linear-gradient(135deg, rgba(236, 253, 45, 0.1), rgba(56, 249, 215, 0.05));
        }
        
        .dark-mode .pagination {
            background: linear-gradient(135deg, rgba(24, 27, 31, 1), rgba(30, 41, 59, 0.5));
            border-color: #334155;
            color: #e2e8f0;
        }
        
        .dark-mode .entries-select {
            background: #0f172a;
            color: #f1f5f9;
            border-color: #475569;
        }
        
        .trend-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.4rem 0.8rem;
            border-radius: 2rem;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s;
        }
        
        .trend-up {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(34, 197, 94, 0.25));
            color: #16a34a;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }
        
        .trend-down {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(239, 68, 68, 0.25));
            color: #dc2626;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .trend-indicator:hover {
            transform: scale(1.1);
        }
        
        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem;
            background: linear-gradient(135deg, rgba(248, 250, 252, 0.5), rgba(241, 245, 249, 0.5));
            border-top: 1px solid var(--border-color);
        }
        
        .pagination-info {
            color: var(--text-secondary);
            font-size: 0.95rem;
            font-weight: 500;
        }
        
        .pagination-controls {
            display: flex;
            gap: 0.75rem;
        }
        
        .pagination-btn {
            padding: 0.75rem 1.25rem;
            border: 2px solid var(--border-color);
            background: #DEAF0B;
            color: var(--text-color);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
        }
       
        
        .pagination-btn:hover:not(:disabled) {
            color: white;
            border-color: #38f9d7;
            background: linear-gradient(135deg, #38f9d7, #4facfe);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(56, 249, 215, 0.3);
        }
        
        .pagination-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }
        
        @media (max-width: 768px) {
            .results-header {
                flex-direction: column;
                align-items: stretch;
                padding: 1rem;
            }
            
            .results-header h1 {
                font-size: 1.5rem;
                text-align: center;
            }
            
            .period-tabs {
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .period-tab {
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
            }
            
            .export-buttons {
                justify-content: center;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
            
            .table-header {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
                padding: 1rem;
            }
            
            .table-controls {
                justify-content: center;
            }
            
            .data-table {
                font-size: 0.85rem;
            }
            
            .data-table th,
            .data-table td {
                padding: 0.75rem 0.5rem;
            }
            
            .pagination {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }
            
            .pagination-controls {
                justify-content: center;
            }
        }
        
        @media (max-width: 480px) {
            .data-table-container {
                overflow-x: auto;
            }
            
            .data-table {
                min-width: 600px;
            }
        }
        
  
        
    </style>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>
    <div id="pageContent">
    <button class="mobile-toggle" id="mobileToggle">
        <span></span>
        <span></span>
        <span></span>
    </button>
    
    <div class="container">
        
        <%- include('partials/sidebar') %>
        
        <div class="main-content">
            <div class="container">
                <div class="results-header">
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <h1>Carbon Intensity Results</h1>
                        <div id="data-source-indicator" style="font-size: 0.85rem; color: var(--text-secondary); display: none;">
                            <i class="fas fa-info-circle"></i> <span id="data-source-text">Loading...</span>
                        </div>
                    </div>
                    
                    <div class="period-tabs">
                        <button class="period-tab active" data-period="day">Today</button>
                        <button class="period-tab" data-period="week">Week</button>
                        <button class="period-tab" data-period="month">Month</button>
                        <button class="period-tab" data-period="quarter">Quarter</button>
                        <button class="period-tab" data-period="year">Year</button>
                    </div>
                    
                    <div class="export-buttons">
                        <button class="export-btn" id="export-csv">
                            <i class="fas fa-file-csv"></i> CSV
                        </button>
                        <button class="export-btn" id="export-pdf">
                            <i class="fas fa-file-pdf"></i> PDF
                        </button>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="stat-emissions">0.00</div>
                        <div class="stat-label">Total Emissions (kg CO₂)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-avoided">0.00</div>
                        <div class="stat-label">Avoided Emissions (kg CO₂)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-efficiency">0.0%</div>
                        <div class="stat-label">Self-Sufficiency Score</div>
                    </div>
                </div>
                
                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-title">Energy Flow & Emissions</div>
                        <div class="chart-container">
                            <canvas id="chart-energy"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-card">
                        <div class="chart-title">Emissions Breakdown</div>
                        <div class="chart-container">
                            <canvas id="chart-emissions"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-card">
                        <div class="chart-title">Carbon Intensity</div>
                        <div class="gauge-container">
                            <canvas id="gauge-carbon" width="200" height="100"></canvas>
                            <div class="gauge-value" id="gauge-carbon-value">0</div>
                        </div>
                    </div>
                    
                    <div class="chart-card">
                        <div class="chart-title">Solar Energy</div>
                        <div class="gauge-container">
                            <canvas id="gauge-solar" width="200" height="100"></canvas>
                            <div class="gauge-value" id="gauge-solar-value">0.0</div>
                        </div>
                    </div>
                </div>
                
                <div class="data-table-container">
                    <div class="table-header">
                        <div class="table-title">Energy Data</div>
                        <div class="table-controls">
                            <label>Show 
                                <select class="entries-select" id="entries-per-page">
                                    <option value="10">10</option>
                                    <option value="25" selected>25</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                </select>
                                entries
                            </label>
                        </div>
                    </div>
                    
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Solar Energy (kWh)</th>
                                <th>Grid Energy (kWh)</th>
                                <th>Emissions (kg CO₂)</th>
                                <th>Avoided (kg CO₂)</th>
                                <th>Efficiency (%)</th>
                                <th>Trend</th>
                            </tr>
                        </thead>
                        <tbody id="table-body">
                        </tbody>
                    </table>
                    
                    <div class="pagination">
                        <div class="pagination-info" id="pagination-info">
                            Showing 0 to 0 of 0 entries
                        </div>
                        <div class="pagination-controls">
                            <button class="pagination-btn" id="prev-page" disabled>
                                <i class="fas fa-chevron-left"></i> Previous
                            </button>
                            <button class="pagination-btn" id="next-page" disabled>
                                Next <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
    
<script src="<%= ingress_path %>/js/loading.js"></script>
    <script src="<%= ingress_path %>/js/dark-mode.js"></script>
    <script src="<%= ingress_path %>/js/mobile.js"></script>
    
    <script>
        const serverPeriods = <%- JSON.stringify(periods) %>;

let currentPeriod = 'day';
let charts = {};
let currentPage = 1;
let entriesPerPage = 25;
let totalEntries = 0;
let currentData = [];

function loadPeriodData(period) {
    currentPeriod = period;
    
    let data = [];
    switch(period) {
        case 'day':
            data = serverPeriods.today || [];
            break;
        case 'week':
            data = serverPeriods.week || [];
            break;
        case 'month':
            data = serverPeriods.month || [];
            break;
        case 'quarter':
            data = serverPeriods.quarter || [];
            break;
        case 'year':
            data = serverPeriods.year || [];
            break;
    }
    
    currentData = data;
    totalEntries = data.length;
    currentPage = 1;

    const stats = calculateStats(data);
    updateStats(stats);
    updateGauges(stats);
    updateCharts(data);
    updateTable();
    
    updateDataSourceIndicator('server', data.length);
}

function calculateStats(data) {
    const totalEmissions = data.reduce((sum, day) => sum + (day.unavoidableEmissions || 0), 0);
    const totalAvoided = data.reduce((sum, day) => sum + (day.avoidedEmissions || 0), 0);
    const avgEfficiency = data.reduce((sum, d) => sum + (d.selfSufficiencyScore || 0), 0) / Math.max(1, data.length);
    const totalSolar = data.reduce((sum, d) => sum + (d.solarEnergy || 0), 0);
    const totalGrid = data.reduce((sum, d) => sum + (d.gridEnergy || 0), 0);
    const avgCarbon = data.reduce((sum, day) => sum + (day.carbonIntensity || 233), 0) / Math.max(1, data.length);

    return {
        emissions: totalEmissions,
        avoided: totalAvoided,
        efficiency: avgEfficiency,
        solar: totalSolar,
        grid: totalGrid,
        carbon: avgCarbon
    };
}

function updateStats(stats) {
    document.getElementById('stat-emissions').textContent = stats.emissions.toFixed(2);
    document.getElementById('stat-avoided').textContent = stats.avoided.toFixed(2);
    document.getElementById('stat-efficiency').textContent = stats.efficiency.toFixed(1) + '%';
}

function updateGauges(stats) {
    document.getElementById('gauge-carbon-value').textContent = stats.carbon.toFixed(0);
    document.getElementById('gauge-solar-value').textContent = stats.solar.toFixed(1);

    createGauge('gauge-carbon', stats.carbon, 500, '#f5576c');
    createGauge('gauge-solar', stats.solar, Math.max(stats.solar * 1.5, 50), '#38f9d7');
}

function createGauge(id, value, max, color) {
    const canvas = document.getElementById(id);
    const ctx = canvas.getContext('2d');
    
    if (charts[id]) {
        charts[id].destroy();
    }

    const isDark = document.documentElement.classList.contains('dark-mode');
    const bgColor = isDark ? 'rgba(51, 65, 85, 0.3)' : 'rgba(226, 232, 240, 0.4)';

    charts[id] = new Chart(ctx, {
        type: 'doughnut',
        data: {
            datasets: [{
                data: [value, max - value],
                backgroundColor: [color, bgColor],
                borderWidth: 0
            }]
        },
        options: {
            circumference: 180,
            rotation: 270,
            cutout: '75%',
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false },
                tooltip: { enabled: false }
            }
        }
    });
}

function updateCharts(data) {
    updateEnergyChart(data);
    updateEmissionsChart(data);
}

function getChartColors() {
    const isDark = document.documentElement.classList.contains('dark-mode');
    return {
        textColor: getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim() || (isDark ? '#f8fafc' : '#1e293b'),
        textSecondary: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim() || (isDark ? '#94a3b8' : '#64748b'),
        borderColor: getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim() || (isDark ? '#334155' : '#e2e8f0'),
        gridColor: isDark ? 'rgba(148, 163, 184, 0.2)' : 'rgba(226, 232, 240, 0.5)'
    };
}

function updateEnergyChart(data) {
    const ctx = document.getElementById('chart-energy');
    
    if (charts['energy']) {
        charts['energy'].destroy();
    }

    const colors = getChartColors();
    const labels = data.map(d => new Date(d.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
    
    charts['energy'] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Solar Energy (kWh)',
                data: data.map(d => d.solarEnergy || 0),
                borderColor: '#38f9d7',
                backgroundColor: 'rgba(56, 249, 215, 0.8)',
                borderWidth: 1,
                yAxisID: 'y'
            }, {
                label: 'Grid Energy (kWh)',
                data: data.map(d => d.gridEnergy || 0),
                borderColor: '#4facfe',
                backgroundColor: 'rgba(79, 172, 254, 0.8)',
                borderWidth: 1,
                yAxisID: 'y'
            }, {
                label: 'Unavoided Emissions (kg CO₂)',
                data: data.map(d => d.unavoidableEmissions || 0),
                borderColor: '#f5576c',
                backgroundColor: 'rgba(245, 87, 108, 0.8)',
                borderWidth: 1,
                yAxisID: 'y1'
            }, {
                label: 'Avoided Emissions (kg CO₂)',
                data: data.map(d => d.avoidedEmissions || 0),
                borderColor: '#22c55e',
                backgroundColor: 'rgba(34, 197, 94, 0.8)',
                borderWidth: 1,
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: {
                    labels: { 
                        color: colors.textColor,
                        font: { size: 11, weight: '500' },
                        usePointStyle: true,
                        padding: 15
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.dataset.label || '';
                            const value = context.parsed.y;
                            if (label.includes('Emissions')) {
                                return `${label}: ${value.toFixed(3)} kg CO₂`;
                            } else {
                                return `${label}: ${value.toFixed(2)} kWh`;
                            }
                        }
                    }
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    beginAtZero: true,
                    grid: { color: colors.gridColor },
                    ticks: { 
                        color: colors.textSecondary,
                        callback: function(value) {
                            return value.toFixed(0) + ' kWh';
                        }
                    },
                    border: { color: colors.borderColor },
                    title: {
                        display: true,
                        text: 'Energy (kWh)',
                        color: colors.textColor,
                        font: { size: 12, weight: '600' }
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    beginAtZero: true,
                    grid: {
                        drawOnChartArea: false,
                    },
                    ticks: { 
                        color: colors.textSecondary,
                        callback: function(value) {
                            return value.toFixed(2) + ' kg';
                        }
                    },
                    border: { color: colors.borderColor },
                    title: {
                        display: true,
                        text: 'CO₂ Emissions (kg)',
                        color: colors.textColor,
                        font: { size: 12, weight: '600' }
                    }
                },
                x: {
                    grid: { color: colors.gridColor },
                    ticks: { color: colors.textSecondary },
                    border: { color: colors.borderColor }
                }
            }
        }
    });
}

function updateEmissionsChart(data) {
    const ctx = document.getElementById('chart-emissions');
    
    if (!ctx) {
        console.error('Emissions chart canvas not found');
        return;
    }
    
    if (charts['emissions']) {
        charts['emissions'].destroy();
    }

    const colors = getChartColors();
    const totalEmissions = data.reduce((sum, d) => sum + (d.unavoidableEmissions || 0), 0);
    const totalAvoided = data.reduce((sum, d) => sum + (d.avoidedEmissions || 0), 0);

    // Ensure we have some data to display
    if (totalEmissions === 0 && totalAvoided === 0) {
        // Show placeholder data
        charts['emissions'] = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['No Data Available'],
                datasets: [{
                    data: [1],
                    backgroundColor: ['#e2e8f0'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { 
                            color: colors.textColor,
                            padding: 20,
                            font: { size: 14, weight: '500' }
                        }
                    }
                }
            }
        });
        return;
    }

    charts['emissions'] = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Unavoidable Emissions', 'Avoided Emissions'],
            datasets: [{
                data: [totalEmissions, totalAvoided],
                backgroundColor: ['#f5576c', '#38f9d7'],
                borderWidth: 0,
                hoverBackgroundColor: ['#f87171', '#4ade80']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { 
                        color: colors.textColor,
                        padding: 20,
                        font: { size: 14, weight: '500' }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed;
                            return `${label}: ${value.toFixed(2)} kg CO₂`;
                        }
                    }
                }
            }
        }
    });
}

function updateTable() {
    const tbody = document.getElementById('table-body');
    tbody.innerHTML = '';

    // Sort data by date in descending order (newest first)
    const sortedData = [...currentData].sort((a, b) => new Date(b.date) - new Date(a.date));
    
    const startIndex = (currentPage - 1) * entriesPerPage;
    const endIndex = Math.min(startIndex + entriesPerPage, totalEntries);
    const pageData = sortedData.slice(startIndex, endIndex);

    pageData.forEach((row, index) => {
        const tr = document.createElement('tr');
        const date = new Date(row.date).toLocaleDateString('en-US', { 
            month: 'short', 
            day: 'numeric',
            year: 'numeric'
        });

        const sortedIndex = startIndex + index;
        const trend = sortedIndex > 0 && sortedData[sortedIndex - 1] 
            ? ((row.selfSufficiencyScore || 0) > (sortedData[sortedIndex - 1].selfSufficiencyScore || 0) ? 'up' : 'down')
            : 'up';

        tr.innerHTML = `
            <td>${date}</td>
            <td>${(row.solarEnergy || 0).toFixed(2)}</td>
            <td>${(row.gridEnergy || 0).toFixed(2)}</td>
            <td>${(row.unavoidableEmissions || 0).toFixed(2)}</td>
            <td>${(row.avoidedEmissions || 0).toFixed(2)}</td>
            <td>${(row.selfSufficiencyScore || 0).toFixed(1)}%</td>
            <td>
                <span class="trend-indicator trend-${trend}">
                    <i class="fas fa-arrow-${trend}"></i>
                </span>
            </td>
        `;
        tbody.appendChild(tr);
    });

    updatePaginationInfo();
}

function updatePaginationInfo() {
    const startIndex = (currentPage - 1) * entriesPerPage + 1;
    const endIndex = Math.min(currentPage * entriesPerPage, totalEntries);
    
    document.getElementById('pagination-info').textContent = 
        `Showing ${startIndex} to ${endIndex} of ${totalEntries} entries`;
    
    document.getElementById('prev-page').disabled = currentPage === 1;
    document.getElementById('next-page').disabled = currentPage >= Math.ceil(totalEntries / entriesPerPage);
}

function exportToCSV() {
    const data = currentData;
    if (!data || data.length === 0) return;

    // Sort data by date in descending order (newest first) for consistent export
    const sortedData = [...data].sort((a, b) => new Date(b.date) - new Date(a.date));

    let csv = 'Date,Solar Energy (kWh),Grid Energy (kWh),Unavoidable Emissions (kg CO₂),Avoided Emissions (kg CO₂),Self-Sufficiency (%),Carbon Intensity (g/kWh)\n';
    
    sortedData.forEach(row => {
        csv += `${row.date},${(row.solarEnergy || 0).toFixed(2)},${(row.gridEnergy || 0).toFixed(2)},${(row.unavoidableEmissions || 0).toFixed(2)},${(row.avoidedEmissions || 0).toFixed(2)},${(row.selfSufficiencyScore || 0).toFixed(1)},${row.carbonIntensity || 0}\n`;
    });

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `energy-data-${currentPeriod}-${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

function exportToPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    const data = currentData;
    if (!data || data.length === 0) return;

    // Sort data by date in descending order (newest first) for consistent export
    const sortedData = [...data].sort((a, b) => new Date(b.date) - new Date(a.date));

    const stats = calculateStats(data);
    
    doc.setFontSize(20);
    doc.text('CARBONOZ Solar Autopilot Report', 20, 30);
    
    doc.setFontSize(14);
    doc.text(`Period: ${currentPeriod.charAt(0).toUpperCase() + currentPeriod.slice(1)}`, 20, 45);
    doc.text(`Generated: ${new Date().toLocaleDateString()}`, 20, 55);
    
    doc.setFontSize(12);
    doc.text('Summary Statistics:', 20, 75);
    doc.text(`Total Unavoided Emissions: ${stats.emissions.toFixed(2)} kg CO₂`, 30, 85);
    doc.text(`Total Avoided Emissions: ${stats.avoided.toFixed(2)} kg CO₂`, 30, 95);
    doc.text(`Net Emissions Reduction: ${(stats.avoided - stats.emissions).toFixed(2)} kg CO₂`, 30, 105);
    doc.text(`Average Efficiency: ${stats.efficiency.toFixed(1)}%`, 30, 115);
    doc.text(`Total Solar Energy: ${stats.solar.toFixed(2)} kWh`, 30, 125);
    doc.text(`Total Grid Energy: ${stats.grid.toFixed(2)} kWh`, 30, 135);
    
    const tableData = sortedData.slice(0, 20).map(row => [
        new Date(row.date).toLocaleDateString(),
        (row.solarEnergy || 0).toFixed(2),
        (row.gridEnergy || 0).toFixed(2),
        (row.unavoidableEmissions || 0).toFixed(2),
        (row.avoidedEmissions || 0).toFixed(2),
        (row.selfSufficiencyScore || 0).toFixed(1) + '%'
    ]);
    
    doc.autoTable({
        head: [['Date', 'Solar (kWh)', 'Grid (kWh)', 'Emissions (kg)', 'Avoided (kg)', 'Efficiency']],
        body: tableData,
        startY: 150,
        styles: { fontSize: 8 },
        headStyles: { fillColor: [51, 65, 85] }
    });
    
    doc.save(`energy-report-${currentPeriod}-${new Date().toISOString().split('T')[0]}.pdf`);
}

function refreshChartsForTheme() {
    if (currentData && currentData.length > 0) {
        const stats = calculateStats(currentData);
        updateCharts(currentData);
        updateGauges(stats);
    }
}

function updateDataSourceIndicator(source, count) {
    const indicator = document.getElementById('data-source-indicator');
    const text = document.getElementById('data-source-text');
    
    if (indicator && text) {
        text.textContent = `Energy data loaded (${count} entries)`;
        indicator.style.display = 'block';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    loadPeriodData('day');
    
    document.querySelectorAll('[data-period]').forEach(btn => {
        btn.addEventListener('click', function() {
            const period = this.dataset.period;
            
            document.querySelectorAll('[data-period]').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            loadPeriodData(period);
        });
    });
    
    document.getElementById('export-csv').addEventListener('click', exportToCSV);
    document.getElementById('export-pdf').addEventListener('click', exportToPDF);
    
    document.getElementById('prev-page').addEventListener('click', function() {
        if (currentPage > 1) {
            currentPage--;
            updateTable();
        }
    });
    
    document.getElementById('next-page').addEventListener('click', function() {
        if (currentPage < Math.ceil(totalEntries / entriesPerPage)) {
            currentPage++;
            updateTable();
        }
    });
    
    document.getElementById('entries-per-page').addEventListener('change', function() {
        entriesPerPage = parseInt(this.value);
        currentPage = 1;
        updateTable();
    });
    
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                setTimeout(refreshChartsForTheme, 100);
            }
        });
    });
    
    observer.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ['class']
    });
});
    </script>
   
</body>
</html>